<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{partials/_header :: common_header(~{::title/text()},~{::link},~{::meta})}">
  <!-- Custom meta data for this template-->
  <meta name="description" content="meo home page">
  <meta name="author" content="mfano">
  <!-- Custom title for this page-->
  <title>admin</title>
  <!-- Custom styles for this page-->
</th:block>

<body>

  <main class="container-fluid">

    <th:block th:insert="~{partials/_nav}" />

    <div class="row">

      <th:block th:insert="~{partials/_sidebar}" />

      <div class="col-lg-10 p-4">

        <h2>Admin Dashboard</h2>
        <p class="text-muted">Manage users, roles and accounts.</p>

        <!-- Create New User -->
        <div class="card my-4">
          <div class="card-body">
            <h5>Create New User</h5>
            <form th:action="@{/admin/create}" method="post" class="row g-2 d-flex">
              <div class="col-md-3">
                <input type="text" class="form-control" name="username" placeholder="Username" required>
              </div>
              <div class="col-md-3">
                <input type="email" class="form-control" name="email" placeholder="Email" required>
              </div>
              <div class="col-md-2">
                <input type="password" class="form-control" name="password" placeholder="Password" required>
              </div>
              <div class="col-md-2">
                <select class="form-select" name="role" required>
                  <option th:each="r : ${roles}" th:text="${r.name}" th:value="${r}">USER</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" type="submit">Create</button>
              </div>
            </form>
          </div>
        </div>

        <!-- User List -->
        <table class="table table-striped table-hover col-sm-12" th:if="${users != null}">
          <thead class="table-dark">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Enabled</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="u : ${users}">
              <td th:text="${u.id}"></td>
              <td th:text="${u.username}"></td>
              <td th:text="${u.email}"></td>
              <td>
                <a class="btn btn-success" th:href="@{'/admin/manage-roles/' + ${u.id}}">manage</a>
              </td>
              <td>
                <span th:text="${u.enabled} ? 'Yes' : 'No'"></span>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <a th:href="@{'/admin/toggle/' + ${u.id}}" class="btn btn-sm btn-warning">Toggle</a>
                  <a th:href="@{'/admin/delete/' + ${u.id}}" class="btn btn-sm btn-danger"
                    onclick="return confirm('Delete this user?')">Delete</a>
                  <a th:href="@{'/admin/resend/' + ${u.id}}" class="btn btn-sm btn-info">Resend</a>

                  <form th:action="@{'/admin/reset-password/' + ${u.id}}" method="post" class="d-inline-flex">
                    <input type="password" name="newPassword" placeholder="New Pass"
                      class="form-control form-control-sm d-inline w-auto" required>
                    <button class="btn btn-sm btn-secondary" type="submit">Reset</button>
                  </form>
                </div>
              </td>

            </tr>
          </tbody>
        </table>

        <h4 class="mt-4">Audit log (latest)</h4>
        <table class="table table-sm" th:if="${auditEntries != null}">
          <thead>
            <tr>
              <th>#</th>
              <th>Action</th>
              <th>By</th>
              <th>Details</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="a : ${auditEntries}">
              <td th:text="${a.id}"></td>
              <td th:text="${a.action}"></td>
              <td th:text="${a.performedBy}"></td>
              <td th:text="${a.details}"></td>
              <td th:text="${a.timestamp}"></td>
            </tr>
          </tbody>
        </table>

        <a href="/logout" class="btn btn-outline-danger d-flex mt-3">Logout</a>
      </div>
    </div>
  </main>

  <th:block th:insert="~{partials/_footer}" />

</body>

</html>